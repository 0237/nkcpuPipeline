# 实验3：指令流水仿真程序
## 背景知识
### 1. 指令流水线
<p>**指令流水线**是用于计算机和其他数字电子设备的设计中增加其指令吞吐量（可以在一个单位时间内执行的指令数）的技术。</p>
<p>基本思想是将计算机指令的处理分成一系列独立的步骤，每个步骤结束时都存储。 这允许计算机的控制电路以最慢步骤的处理速率发出指令，这比同时执行所有步骤所需的时间快得多。 术语管道是指每个步骤一次携带数据（如水），每个步骤连接到下一个（如管道的链接）。</p>
<p>大多数现代CPU都是由时钟驱动的。 CPU内部由逻辑和寄存器组成。 当时钟信号到达时，触发器取其新值，然后逻辑需要一段时间来解码新值。 然后下一个时钟脉冲到达，触发器再次取得新值，依此类推。 通过将逻辑分解成更小的部分并在两条逻辑之间插入触发器，逻辑给出有效输出之前的延迟就减少了。 这样可以减少时钟周期。 例如，经典的RISC流水线分为五个阶段，每个阶段之间有一组触发器。</p>

1. 指令提取
2. 指令译码和寄存器取出
3. 执行
4. 内存访问
5. 寄存器回写

<p>当程序员（或编译器）编写汇编代码时，他们假设在执行后续指令的时候执行每个指令。 这种假设通过流水线无效。 当这导致程序的行为不正确时，这种情况被称为危险。 存在用于解决诸如转发和停止等危险的各种技术。</p>
<p>非管道架构效率低下，因为某些CPU组件（模块）处于空闲状态，而另一个模块在指令周期内处于活动状态。 流水线不能完全消除CPU中的空闲时间，但使这些模块并行工作显着提高了程序执行。</p>
<p>流水线处理器可以分为几个阶段，可以在独立工作中进行半独立工作。 每个阶段都被组织并链接到一个“链”，所以每个阶段的输出都被馈送到另一个阶段，直到完成工作。 该处理器的组织允许整体处理时间显着减少。</p>
<p>更深的流水线意味着管道中有更多的阶段，因此在每个阶段都有较少的逻辑门。 这通常意味着处理器的频率可以随着周期时间的降低而增加。 这是因为管道的每个阶段中的组件数量较少，因此整个阶段的传播延迟会减少。</p>
<p>不幸的是，并不是所有的指令都是独立的。 在样本管道中，完成和指导可能需要5个阶段。 要全面运行，这个管道将需要运行4个后续独立指令，而第一个完成。 如果不依赖于第一条指令的输出的4条指令不可用，则流水线控制逻辑必须在流水线中插入停顿或浪费的时钟周期，直到依赖关系解决为止。 幸运的是，诸如转发的技术可以显着减少需要停车的情况。 虽然流水线可以在理论上通过一个阶段数量的因素（假定时钟频率也随着阶段数量的增加而增加）在无流水线核心上的性能提高，但实际上，大多数代码不允许理想的执行。</p>
<p>流通在所有情况下都没有帮助。有几个可能的缺点。 如果每个时钟周期可以接受新的指令，则指令流水线被完全输出。 没有完全流水线的管道具有延迟管道进度的等待循环。</p>

#### *流水的优点：*

1. 处理器的循环时间减少，从而在大多数情况下增加指令发布率。
2. 通过添加更多的电路，可以使一些组合电路（如加法器或乘法器）变得更快。 如果使用流水线，则可以节省电路与更复杂的组合电路。

####*流水的缺点：*

1. 非流水线处理器一次只执行一条指令。 这样可以防止分支延迟（实际上每个分支都被延迟），同时执行串行指令的问题。 因此，制造的设计更简单和便宜。
2. 非流水线处理器中的指令延迟略低于流水线处理的等效值。 这是因为额外的触发器必须被添加到流水线处理器的数据路径中。
3. 非流水线处理器将具有稳定的指令带宽。 流水线处理器的性能难以预测，并且可能在不同程序之间变化更大。

### 2. 经典 RISC 流水
<p>在计算机硬件的历史上，一些早期的精简指令集计算机中央处理器（RISC CPU）使用了非常相似的架构解决方案，现在称之为经典的 RISC 流水。 那些 CPU 是： MIPS，SPARC，Motorola 88000 和更高版本的 DLX 。</p>
<p>这些经典标量 RISC 设计中的每一个都获取并尝试每个周期执行一个指令。 每个设计的主要常见概念是五阶段执行指令流水线。 在运行期间，每个流水线阶段一次可以在一个指令上工作。</p>
<p>这些阶段中的每一个由初始的触发器组合组成，并且组合逻辑在这些触发器的输出上操作。</p>

#### 经典五段 RISC 流水
##### *取指*
<p>这些机器上的指令 Cache 有一个周期的延迟。 在指令提取阶段，从缓存中提取了一个 32 位指令。</p>
<p>PC 预测器将程序计数器（PC）发送到指令高速缓存以读取当前指令。 同时，PC 预测器通过将 PC 递增 4（所有指令都是 4 个字节长）来预测下一条指令的地址。 在采取分支，跳跃或异常的情况下，这种预测总是错误的。 后来的机器将使用更复杂和准确的算法来猜测下一个指令地址。</p>

##### *译码*
<p>与以前的微型编码机不同，第一台 RISC 机器没有微码。 一旦从指令高速缓存中取出，指令位就沿流水线向下移动，因此每个流水线阶段的简单组合逻辑可以直接从指令位产生数据通路的控制信号。 结果，在传统上称为解码级的阶段中完成了很少的解码。</p>
<p>同时读取寄存器文件，该阶段的指令发出逻辑确定管线是否准备好在该阶段执行指令。 如果不是，问题逻辑将导致指令提取阶段和解码阶段停止。 在一个停顿周期，这些阶段将阻止他们的初始翻牌接受新的比特。</p>
<p>如果解码的指令是分支或跳转，则与读取寄存器文件并行计算分支或跳转的目标地址。 在寄存器文件被读取之后计算分支条件，并且如果分支被采取或者指令是跳转，则第一级中的 PC 预测器被分配分支目标，而不是被计算的增加的 PC。</p>
<p>解码阶段结束了相当多的硬件：如果两个寄存器相等，MIPS 指令集有可能进行分支，因此在寄存器文件读取之后，32 位宽的 AND 树串联运行，使得一个非常长的关键路径 通过这个阶段 此外，分支目标计算通常需要 16 个加法器和 14 位加法器。 在解码阶段解决分支使得可能只有一个单周期分支错误预测的惩罚。 由于分支经常被采取（因此被误用），因此将这一惩罚降低到非常重要。</p>

##### *执行*
<p>关于这些简单 RISC 机器的说明可以根据操作类型分为三个等待时间类别：</p>

- 寄存器寄存器操作（单周期延迟）：加，减，比较和逻辑运算。 在执行阶段，两个参数被馈送到一个简单的 ALU，它在执行阶段结束时生成结果。
- 内存参考（两周期延迟）。 所有负载从内存。 在执行阶段，ALU 添加了两个参数（寄存器和常量偏移量），以在循环结束时产生一个虚拟地址。
- 多周期指令（许多周期延迟）。 整数乘法和除法以及所有浮点运算。 在执行阶段，这些操作的操作数被馈送到多周期乘法 / 除法单元。 其余的管道可以自由地继续执行，而倍增 / 分裂单元工作。 为了避免复写阶段和发布逻辑，多周期指令将其结果写入单独的寄存器集。

##### *访存*
<p>在这个阶段，单循环延迟指令只需将其结果转发到下一阶段。 此转发确保单循环和两循环指令始终将其结果写入流水线的同一阶段，以便只能使用一个写入端口到寄存器文件，并且始终可用。</p>

##### *写回*
<p>在此阶段，单周期和两周期指令将其结果写入寄存器文件。</p>

## 实验内容

1.  定义 NK-CPU 指令流水线仿真的基本数据结构
2.  使用 C 语言实现 NK-CPU 指令流水线仿真程序
3.  仿真运行实验 2 中实现的随机数排序程序

## 实验要求

1. 仿真程序具有基本功能包括：
    - 可以编辑和查看“数据存储器”的内容
    - 可以查看“汇编语言”程序
    - 可以查看 NK-CPU 寄存器的内容
    - 可以显示指令流水线的运行状态
    - 可以控制程序“执行”、“单步执行”
2. 仿真程序界面布局建议：

![](2.bmp)<br>